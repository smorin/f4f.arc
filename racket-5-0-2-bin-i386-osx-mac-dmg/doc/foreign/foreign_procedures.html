<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text-html; charset=utf-8" /><title>3.6&nbsp;Function Types</title><link rel="stylesheet" type="text/css" href="../scribble.css" title="default" /><link rel="stylesheet" type="text/css" href="../racket.css" title="default" /><link rel="stylesheet" type="text/css" href="../scribble-style.css" title="default" /><script type="text/javascript" src="../scribble-common.js"></script></head><body id="doc-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist" style="margin-bottom: 1em;"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="index.html" class="tocviewlink" pltdoc="x"><span style="font-weight: bold">FFI</span>:<span class="mywbr"> </span> Racket Foreign Interface</a></td></tr></table></div><div class="tocviewsublisttop" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="intro.html" class="tocviewlink" pltdoc="x">Overview</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="Loading_Foreign_Libraries.html" class="tocviewlink" pltdoc="x">Loading Foreign Libraries</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="types.html" class="tocviewselflink" pltdoc="x">C Types</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="foreign_pointer-funcs.html" class="tocviewlink" pltdoc="x">Pointer Functions</a></td></tr><tr><td align="right">5&nbsp;</td><td><a href="Derived_Utilities.html" class="tocviewlink" pltdoc="x">Derived Utilities</a></td></tr><tr><td align="right">6&nbsp;</td><td><a href="Miscellaneous_Support.html" class="tocviewlink" pltdoc="x">Miscellaneous Support</a></td></tr><tr><td align="right">7&nbsp;</td><td><a href="foreign_c-only.html" class="tocviewlink" pltdoc="x">Unexported Primitive Functions</a></td></tr><tr><td align="right"></td><td><a href="doc-index.html" class="tocviewlink" pltdoc="x">Index</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_1&quot;);">&#9660;</a></td><td>3&nbsp;</td><td><a href="types.html" class="tocviewlink" pltdoc="x">C Types</a></td></tr></table><div class="tocviewsublist" style="display: block;" id="tocview_1"><table cellspacing="0" cellpadding="0"><tr><td align="right">3.1&nbsp;</td><td><a href="ctype.html" class="tocviewlink" pltdoc="x">Type Constructors</a></td></tr><tr><td align="right">3.2&nbsp;</td><td><a href="Numeric_Types.html" class="tocviewlink" pltdoc="x">Numeric Types</a></td></tr><tr><td align="right">3.3&nbsp;</td><td><a href="Other_Atomic_Types.html" class="tocviewlink" pltdoc="x">Other Atomic Types</a></td></tr><tr><td align="right">3.4&nbsp;</td><td><a href="String_Types.html" class="tocviewlink" pltdoc="x">String Types</a></td></tr><tr><td align="right">3.5&nbsp;</td><td><a href="Pointer_Types.html" class="tocviewlink" pltdoc="x">Pointer Types</a></td></tr><tr><td align="right">3.6&nbsp;</td><td><a href="" class="tocviewselflink" pltdoc="x">Function Types</a></td></tr><tr><td align="right">3.7&nbsp;</td><td><a href="C_Struct_Types.html" class="tocviewlink" pltdoc="x">C Struct Types</a></td></tr><tr><td align="right">3.8&nbsp;</td><td><a href="Enumerations_and_Masks.html" class="tocviewlink" pltdoc="x">Enumerations and Masks</a></td></tr></table></div></div><div class="tocviewlist"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_2&quot;);">&#9658;</a></td><td>3.6&nbsp;</td><td><a href="" class="tocviewselflink" pltdoc="x">Function Types</a></td></tr></table><div class="tocviewsublistbottom" style="display: none;" id="tocview_2"><table cellspacing="0" cellpadding="0"><tr><td align="right">3.6.1&nbsp;</td><td><a href="#(part._foreign~3acustom-types)" class="tocviewlink" pltdoc="x">Custom Function Types</a></td></tr></table></div></div></div><div class="tocsub"><div class="tocsubtitle">On this page:</div><table class="tocsublist" cellspacing="0"><tr><td><a href="#(def._((lib._ffi/unsafe..rkt).__cprocedure))" class="tocsubnonseclink" pltdoc="x"><span title="Provided from: ffi/unsafe"><span class="RktSym"><span class="RktValLink">_<span class="mywbr"> </span>cprocedure</span></span></span></a></td></tr><tr><td><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="tocsubnonseclink" pltdoc="x"><span title="Provided from: ffi/unsafe"><span class="RktSym"><span class="RktStxLink">_<span class="mywbr"> </span>fun</span></span></span></a></td></tr><tr><td><a href="#(def._((lib._ffi/unsafe..rkt)._function-ptr))" class="tocsubnonseclink" pltdoc="x"><span title="Provided from: ffi/unsafe"><span class="RktSym"><span class="RktValLink">function-<wbr></wbr>ptr</span></span></span></a></td></tr><tr><td><span class="tocsublinknumber">3.6.1<tt>&nbsp;</tt></span><a href="#(part._foreign~3acustom-types)" class="tocsubseclink" pltdoc="x">Custom Function Types</a></td></tr><tr><td><a href="#(form._((lib._ffi/unsafe..rkt)._define-fun-syntax))" class="tocsubnonseclink" pltdoc="x"><span title="Provided from: ffi/unsafe"><span class="RktSym"><span class="RktStxLink">define-<wbr></wbr>fun-<wbr></wbr>syntax</span></span></span></a></td></tr><tr><td><a href="#(form._((lib._ffi/unsafe..rkt).__~3f))" class="tocsubnonseclink" pltdoc="x"><span title="Provided from: ffi/unsafe"><span class="RktSym"><span class="RktStxLink">_<span class="mywbr"> </span>?</span></span></span></a></td></tr><tr><td><a href="#(form._((lib._ffi/unsafe..rkt).__ptr))" class="tocsubnonseclink" pltdoc="x"><span title="Provided from: ffi/unsafe"><span class="RktSym"><span class="RktStxLink">_<span class="mywbr"> </span>ptr</span></span></span></a></td></tr><tr><td><a href="#(form._((lib._ffi/unsafe..rkt).__box))" class="tocsubnonseclink" pltdoc="x"><span title="Provided from: ffi/unsafe"><span class="RktSym"><span class="RktStxLink">_<span class="mywbr"> </span>box</span></span></span></a></td></tr><tr><td><a href="#(form._((lib._ffi/unsafe..rkt).__list))" class="tocsubnonseclink" pltdoc="x"><span title="Provided from: ffi/unsafe"><span class="RktSym"><span class="RktStxLink">_<span class="mywbr"> </span>list</span></span></span></a></td></tr><tr><td><a href="#(form._((lib._ffi/unsafe..rkt).__vector))" class="tocsubnonseclink" pltdoc="x"><span title="Provided from: ffi/unsafe"><span class="RktSym"><span class="RktStxLink">_<span class="mywbr"> </span>vector</span></span></span></a></td></tr><tr><td><a href="#(form._((lib._ffi/unsafe..rkt).__bytes))" class="tocsubnonseclink" pltdoc="x"><span title="Provided from: ffi/unsafe"><span class="RktSym"><span class="RktStxLink">_<span class="mywbr"> </span>bytes</span></span></span></a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="navsettop"><span class="navleft"><form class="searchform"><input class="searchbox" style="color: #888;" type="text" value="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;5.0.2&quot;, &quot;../&quot;);" onfocus="this.style.color=&quot;black&quot;; this.style.textAlign=&quot;left&quot;; if (this.value == &quot;...search manuals...&quot;) this.value=&quot;&quot;;" onblur="if (this.value.match(/^ *$/)) { this.style.color=&quot;#888&quot;; this.style.textAlign=&quot;center&quot;; this.value=&quot;...search manuals...&quot;; }" /></form>&nbsp;&nbsp;<a href="../index.html" title="up to the documentation top" pltdoc="x" onclick="return GotoPLTRoot(&quot;5.0.2&quot;);">top</a></span><span class="navright"><a href="Pointer_Types.html" title="backward to &quot;3.5 Pointer Types&quot;" pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="types.html" title="up to &quot;3 C Types&quot;" pltdoc="x">up</a>&nbsp;&nbsp;<a href="C_Struct_Types.html" title="forward to &quot;3.7 C Struct Types&quot;" pltdoc="x">next &rarr;</a></span>&nbsp;</div><h4>3.6<tt>&nbsp;</tt><a name="(part._foreign~3aprocedures)"></a>Function Types</h4><p><div class="SIntrapara"><table cellspacing="0" class="boxed"><tr><td><table cellspacing="0" class="prototype"><tr><td><span class="RktPn">(</span><a name="(dep._((lib._ffi/unsafe..rkt).__cprocedure))"></a><a name="(def._((lib._ffi/unsafe..rkt).__cprocedure))"></a><span title="Provided from: ffi/unsafe"><span class="RktSym"><a href="#(def._((lib._ffi/unsafe..rkt).__cprocedure))" class="RktValLink" pltdoc="x">_cprocedure</a></span></span></td><td><span class="hspace">&nbsp;</span></td><td><span class="RktVar">input-types</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="RktVar">output-type</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span>[</td><td><span class="RktPn">#:abi</span><span class="hspace">&nbsp;</span><span class="RktVar">abi</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="RktPn">#:atomic?</span><span class="hspace">&nbsp;</span><span class="RktVar">atomic?</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="RktPn">#:async-apply</span><span class="hspace">&nbsp;</span><span class="RktVar">async-apply</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="RktPn">#:save-errno</span><span class="hspace">&nbsp;</span><span class="RktVar">save-errno</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="RktPn">#:wrapper</span><span class="hspace">&nbsp;</span><span class="RktVar">wrapper</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td><td><span class="hspace">&nbsp;</span></td><td><span class="RktPn">#:keep</span><span class="hspace">&nbsp;</span><span class="RktVar">keep</span>]<span class="RktPn">)</span></td><td><span class="hspace">&nbsp;</span></td><td>&rarr;</td><td><span class="hspace">&nbsp;</span></td><td><span class="RktSym"><a href="../reference/Data-structure_Contracts.html#(form._((lib._racket/contract/private/guts..rkt)._any))" class="RktStxLink" pltdoc="x">any</a></span></td></tr></table></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">input-types</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/pairs.html#(def._((quote._~23~25kernel)._list))" class="RktValLink" pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="ctype.html#(def._((quote._~23~25foreign)._ctype~3f))" class="RktValLink" pltdoc="x">ctype?</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">output-type</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="ctype.html#(def._((quote._~23~25foreign)._ctype~3f))" class="RktValLink" pltdoc="x">ctype?</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">abi</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Data-structure_Contracts.html#(def._((lib._racket/contract/private/misc..rkt)._or/c))" class="RktValLink" pltdoc="x">or/c</a></span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">default</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">stdcall</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">sysv</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>=<span class="hspace">&nbsp;</span><span class="RktVal">#f</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">atomic?</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/Data-structure_Contracts.html#(def._((lib._racket/contract/private/guts..rkt)._any/c))" class="RktValLink" pltdoc="x">any/c</a></span><span class="hspace">&nbsp;</span>=<span class="hspace">&nbsp;</span><span class="RktVal">#f</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">async-apply</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Data-structure_Contracts.html#(def._((lib._racket/contract/private/misc..rkt)._or/c))" class="RktValLink" pltdoc="x">or/c</a></span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Function_Contracts.html#(form._((lib._racket/contract..rkt)._-~3e))" class="RktStxLink" pltdoc="x">-&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/Data-structure_Contracts.html#(form._((lib._racket/contract/private/guts..rkt)._any))" class="RktStxLink" pltdoc="x">any</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">. </span><span class="RktSym"><a href="../reference/Function_Contracts.html#(form._((lib._racket/contract..rkt)._-~3e))" class="RktStxLink" pltdoc="x">-&gt;</a></span><span class="RktPn"> .</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/Data-structure_Contracts.html#(form._((lib._racket/contract/private/guts..rkt)._any))" class="RktStxLink" pltdoc="x">any</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>=<span class="hspace">&nbsp;</span><span class="RktVal">#f</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">save-errno</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Data-structure_Contracts.html#(def._((lib._racket/contract/private/misc..rkt)._or/c))" class="RktValLink" pltdoc="x">or/c</a></span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">posix</span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">windows</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>=<span class="hspace">&nbsp;</span><span class="RktVal">#f</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">wrapper</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Data-structure_Contracts.html#(def._((lib._racket/contract/private/misc..rkt)._or/c))" class="RktValLink" pltdoc="x">or/c</a></span><span class="hspace">&nbsp;</span><span class="RktVal">#f</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/procedures.html#(def._((quote._~23~25kernel)._procedure~3f))" class="RktValLink" pltdoc="x">procedure?</a></span><span class="hspace">&nbsp;</span><span class="RktPn">. </span><span class="RktSym"><a href="../reference/Function_Contracts.html#(form._((lib._racket/contract..rkt)._-~3e))" class="RktStxLink" pltdoc="x">-&gt;</a></span><span class="RktPn"> .</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/procedures.html#(def._((quote._~23~25kernel)._procedure~3f))" class="RktValLink" pltdoc="x">procedure?</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>=<span class="hspace">&nbsp;</span><span class="RktVal">#f</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">keep</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Data-structure_Contracts.html#(def._((lib._racket/contract/private/misc..rkt)._or/c))" class="RktValLink" pltdoc="x">or/c</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/booleans.html#(def._((quote._~23~25kernel)._boolean~3f))" class="RktValLink" pltdoc="x">boolean?</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/boxes.html#(def._((quote._~23~25kernel)._box~3f))" class="RktValLink" pltdoc="x">box?</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/Data-structure_Contracts.html#(def._((lib._racket/contract/private/guts..rkt)._any/c))" class="RktValLink" pltdoc="x">any/c</a></span><span class="hspace">&nbsp;</span><span class="RktPn">. </span><span class="RktSym"><a href="../reference/Function_Contracts.html#(form._((lib._racket/contract..rkt)._-~3e))" class="RktStxLink" pltdoc="x">-&gt;</a></span><span class="RktPn"> .</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/Data-structure_Contracts.html#(def._((lib._racket/contract/private/guts..rkt)._any/c))" class="RktValLink" pltdoc="x">any/c</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>=<span class="hspace">&nbsp;</span><span class="RktVal">#t</span></td></tr></table></div><div class="SIntrapara">A type constructor that creates a new function type, which is
specified by the given <span class="RktVar">input-types</span> list and <span class="RktVar">output-type</span>.
Usually, the <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span> syntax (described below) should be used
instead, since it manages a wide range of complicated cases.</div></p><p>The resulting type can be used to reference foreign functions (usually
<span class="RktSym">ffi-obj</span>s, but any pointer object can be referenced with this type),
generating a matching foreign callout object.  Such objects are new primitive
procedure objects that can be used like any other Racket procedure.
As with other pointer types, <span class="RktVal">#f</span> is treated as a <span class="stt">NULL</span>
function pointer and vice versa.</p><p>A type created with <span class="RktSym"><a href="#(def._((lib._ffi/unsafe..rkt).__cprocedure))" class="RktValLink" pltdoc="x">_cprocedure</a></span> can also be used for passing
Racket procedures to foreign functions, which will generate a foreign
function pointer that calls the given Racket procedure when it is
used.  There are no restrictions on the Racket procedure; in
particular, its lexical context is properly preserved.</p><p>The optional <span class="RktVar">abi</span> keyword argument determines the foreign ABI
that is used.  <span class="RktVal">#f</span> or <span class="RktVal">'</span><span class="RktVal">default</span> will use a
platform-dependent default; other possible values are
<span class="RktVal">'</span><span class="RktVal">stdcall</span> and <span class="RktVal">'</span><span class="RktVal">sysv</span> (the latter corresponds to
&ldquo;cdecl&rdquo;).  This is especially important on Windows, where most
system functions are <span class="RktVal">'</span><span class="RktVal">stdcall</span>, which is not the default.</p><p>If <span class="RktVar">atomic?</span> is true, then when a Racket procedure is given
this procedure type and called from foreign code, then the Racket
process is put into atomic mode while evaluating the Racket procedure
body. In atomic mode, other Racket threads do not run, so the Racket
code must not call any function that potentially blocks on
synchronization with other threads, or else it may lead to deadlock. In
addition, the Racket code must not perform any potentially blocking
operation (such as I/O), it must not raise an uncaught exception, it
must not perform any escaping continuation jumps, and its non-tail
recursion must be minimal to avoid C-level stack overflow; otherwise,
the process may crash or misbehave.</p><p>If an <span class="RktVar">async-apply</span> procedure is provided, then a Racket
procedure with the generated procedure type can be applied in a
foreign thread (i.e., an OS-level thread other than the one used to
run Racket). The call in the foreign thread is transferred to the
OS-level thread that runs Racket, but the Racket-level thread (in the
sense of <span class="RktSym"><a href="../reference/threads.html#(def._((quote._~23~25kernel)._thread))" class="RktValLink" pltdoc="x">thread</a></span>) is unspecified; the job of
<span class="RktVar">async-apply</span> is to arrange for the callback procedure to be
run in a suitable Racket thread. The <span class="RktVar">async-apply</span> function is
applied to a thunk that encapsulates the specific callback invocation,
and the foreign OS-level thread blocks until the thunk is called and
completes; the thunk must be called exactly once, and the callback
invocation must return normally. The <span class="RktVar">async-apply</span> procedure
itself is called in atomic mode (see <span class="RktVar">atomic?</span> above). If the
callback is known to complete quickly, requires no synchronization,
and works independent of the Racket thread in which it runs, then
<span class="RktVar">async-apply</span> can apply the thunk directly. Otherwise,
<span class="RktVar">async-apply</span> must arrange for the thunk to be applied in a
suitable Racket thread sometime after <span class="RktVar">async-apply</span> itself
returns; if the thunk raises an exception or synchronizes within an
unsuitable Racket-level thread, it can deadlock or otherwise damage
the Racket process. Foreign-thread detection to trigger
<span class="RktVar">async-apply</span> works only when Racket is compiled with OS-level
thread support, which is the default for many platforms. If a callback
with an <span class="RktVar">async-apply</span> is called from foreign code in the same
OS-level thread that runs Racket, then the <span class="RktVar">async-apply</span> wrapper is
not used.</p><p>If <span class="RktVar">save-errno</span> is <span class="RktVal">'</span><span class="RktVal">posix</span>, then the value of
<a name="(idx._(gentag._3._(lib._scribblings/foreign/foreign..scrbl)))"></a><span class="stt">errno</span> is saved (specific to the current thread)
immediately after a foreign function returns. The saved value is
accessible through <span class="RktSym"><a href="Miscellaneous_Support.html#(def._((quote._~23~25foreign)._saved-errno))" class="RktValLink" pltdoc="x">saved-errno</a></span>. If <span class="RktVar">save-errno</span> is
<span class="RktVal">'</span><span class="RktVal">windows</span>, then the value of
<a name="(idx._(gentag._4._(lib._scribblings/foreign/foreign..scrbl)))"></a><span class="stt">GetLastError</span><span class="stt">()</span> is saved for later use via
<span class="RktSym"><a href="Miscellaneous_Support.html#(def._((quote._~23~25foreign)._saved-errno))" class="RktValLink" pltdoc="x">saved-errno</a></span>; the <span class="RktVal">'</span><span class="RktVal">windows</span> option is available only
under Windows (on other platforms <span class="RktSym"><a href="Miscellaneous_Support.html#(def._((quote._~23~25foreign)._saved-errno))" class="RktValLink" pltdoc="x">saved-errno</a></span> will return
0). If <span class="RktVar">save-errno</span> is <span class="RktVal">#f</span>, no error value is saved
automatically. The error-recording support provided by
<span class="RktVar">save-errno</span> is needed because the Racket runtime system
may otherwise preempt the current Racket thread and itself call
functions that set error values.</p><p>The optional <span class="RktVar">wrapper</span>, if provided, is expected to be a
function that can change a callout procedure: when a callout is
generated, the wrapper is applied on the newly created primitive
procedure, and its result is used as the new function.  Thus,
<span class="RktVar">wrapper</span> is a hook that can perform various argument
manipulations before the foreign function is invoked, and return
different results (for example, grabbing a value stored in an
&ldquo;output&rdquo; pointer and returning multiple values).  It can also be
used for callbacks, as an additional layer that tweaks arguments from
the foreign code before they reach the Racket procedure, and possibly
changes the result values too.</p><p><div class="SIntrapara">Sending Racket functions as callbacks to foreign code is achieved by
translating them to a foreign &ldquo;closure,&rdquo; which foreign code can call
as plain C functions.  Additional care must be taken in case the
foreign code might hold on to the callback function.  In these cases
you must arrange for the callback value to not be garbage-collected,
or the held callback will become invalid.  The optional <span class="RktVar">keep</span>
keyword argument is used to achieve this.  It can have the following
values: </div><div class="SIntrapara"><ul><li><p><span class="RktVal">#t</span> makes the callback value stay in memory as long as
the converted function is.  In order to use this, you need to hold
on to the original function, for example, have a binding for it.
Note that each function can hold onto one callback value (it is
stored in a weak hash table), so if you need to use a function in
multiple callbacks you will need to use one of the last two
options below.  (This is the default, as it is fine in most cases.)</p></li><li><p><span class="RktVal">#f</span> means that the callback value is not held.  This may
be useful for a callback that is only used for the duration of the
foreign call  &ndash;  for example, the comparison function argument to
the standard C library <span class="stt">qsort</span> function is only used while
<span class="stt">qsort</span> is working, and no additional references to the
comparison function are kept.  Use this option only in such cases,
when no holding is necessary and you want to avoid the extra cost.</p></li><li><p>A box holding <span class="RktVal">#f</span> (or a callback value)  &ndash;  in this case
the callback value will be stored in the box, overriding any value
that was in the box (making it useful for holding a single callback
value).  When you know that it is no longer needed, you can
&ldquo;release&rdquo; the callback value by changing the box contents, or by
allowing the box itself to be garbage-collected.  This is can be
useful if the box is held for a dynamic extent that corresponds to
when the callback is needed; for example, you might encapsulate some
foreign functionality in a Racket class or a unit, and keep the
callback box as a field in new instances or instantiations of the
unit.</p></li><li><p>A box holding <span class="RktSym"><a href="../reference/pairs.html#(def._((quote._~23~25kernel)._null))" class="RktValLink" pltdoc="x">null</a></span> (or any list) &ndash; this is similar to
the previous case, except that new callback values are consed onto
the contents of the box.  It is therefore useful in (rare) cases
when a Racket function is used in multiple callbacks (that is, sent
to foreign code to hold onto multiple times).</p></li><li><p>Finally, if a one-argument function is provided as
<span class="RktVar">keep</span>, it will be invoked with the callback value when it
is generated.  This allows you to grab the value directly and use it
in any way.</p></li></ul></div></p><p><div class="SIntrapara"><table cellspacing="0" class="boxed"><tr><td><table cellspacing="0" class="RktBlk"><tr><td><span class="RktPn">(</span><a name="(dep._((lib._ffi/unsafe..rkt).__fun))"></a><a name="(form._((lib._ffi/unsafe..rkt).__fun))"></a><span title="Provided from: ffi/unsafe"><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span></span><span class="hspace">&nbsp;</span><span class="RktVar">fun-option</span><span class="hspace">&nbsp;</span><span class="RktMeta">...</span><span class="hspace">&nbsp;</span><span class="RktVar">maybe-args</span><span class="hspace">&nbsp;</span><span class="RktVar">type-spec</span><span class="hspace">&nbsp;</span><span class="RktMeta">...</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/Function_Contracts.html#(form._((lib._racket/contract..rkt)._-~3e))" class="RktStxLink" pltdoc="x">-&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktVar">type-spec</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktVar">maybe-wrapper</span><span class="RktPn">)</span></td></tr></table></td></tr><tr><td><span class="stt">&nbsp;</span></td></tr><tr><td><table cellspacing="0" class="specgrammar"><tr><td align="right" valign="baseline"><span class="RktVar">fun-option</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">=</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktPn">#:abi</span><span class="hspace">&nbsp;</span><span class="RktVar">abi-expr</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktPn">#:save-errno</span><span class="hspace">&nbsp;</span><span class="RktVar">save-errno-expr</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktPn">#:keep</span><span class="hspace">&nbsp;</span><span class="RktVar">keep-expr</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktPn">#:atomic?</span><span class="hspace">&nbsp;</span><span class="RktVar">atomic?-expr</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktPn">#:async-apply</span><span class="hspace">&nbsp;</span><span class="RktVar">async-apply-expr</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td></tr><tr><td align="right" valign="baseline"><span class="RktVar">maybe-args</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">=</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><table cellspacing="0" class="RktBlk"><tr><td></td></tr></table></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktVar">id</span><span class="hspace">&nbsp;</span><span class="RktMeta">...</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">::</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktVar">id</span><span class="hspace">&nbsp;</span><span class="RktSym">::</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktVar">id</span><span class="hspace">&nbsp;</span><span class="RktMeta">...</span><span class="hspace">&nbsp;</span><span class="RktPn">. </span><span class="RktVar">id</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">::</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td></tr><tr><td align="right" valign="baseline"><span class="RktVar">type-spec</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">=</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktVar">type-expr</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktVar">id</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktVar">type-expr</span><span class="RktPn">)</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktVar">type-expr</span><span class="hspace">&nbsp;</span><span class="RktVar">=</span><span class="hspace">&nbsp;</span><span class="RktVar">value-expr</span><span class="RktPn">)</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktPn">(</span><span class="RktVar">id</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktVar">type-expr</span><span class="hspace">&nbsp;</span><span class="RktVar">=</span><span class="hspace">&nbsp;</span><span class="RktVar">value-expr</span><span class="RktPn">)</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td></tr><tr><td align="right" valign="baseline"><span class="RktVar">maybe-wrapper</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">=</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><table cellspacing="0" class="RktBlk"><tr><td></td></tr></table></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktSym"><a href="../reference/Function_Contracts.html#(form._((lib._racket/contract..rkt)._-~3e))" class="RktStxLink" pltdoc="x">-&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktVar">output-expr</span></td></tr></table></td></tr></table></div><div class="SIntrapara">Creates a new function type.  The <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span> form is a convenient
syntax for the <span class="RktSym"><a href="#(def._((lib._ffi/unsafe..rkt).__cprocedure))" class="RktValLink" pltdoc="x">_cprocedure</a></span> type constructor. In its simplest
form, only the input <span class="RktVar">type-expr</span>s and the output <span class="RktVar">type-expr</span> are
specified, and each types is a simple expression, which creates a
straightforward function type.</div></p><p>For instance,</p><p><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__int))" class="RktValLink" pltdoc="x">_int</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="String_Types.html#(def._((lib._ffi/unsafe..rkt).__string))" class="RktValLink" pltdoc="x">_string</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/Function_Contracts.html#(form._((lib._racket/contract..rkt)._-~3e))" class="RktStxLink" pltdoc="x">-&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__int))" class="RktValLink" pltdoc="x">_int</a></span><span class="RktPn">)</span></p><p>specifies a function that receives an integer and a
string, and returns an integer.</p><p>In its full form, the <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span> syntax provides an IDL-like
language that can be used to create a wrapper function around the
primitive foreign function.  These wrappers can implement complex
foreign interfaces given simple specifications. The full form of each
of the type specifications can include an optional label and an
expression. If a <span class="RktVar">=</span><span class="stt"> </span><span class="RktVar">value-expr</span> is provided, then the resulting
function will be a wrapper that calculates the argument for that
position itself, meaning that it does not expect an argument for that
position.  The expression can use previous arguments if they were
labeled with <span class="RktVar">id</span><span class="stt"> </span><span class="RktSym">:</span>.  In addition, the result of a function
call need not be the value returned from the foreign call: if the
optional <span class="RktVar">output-expr</span> is specified, or if an expression is
provided for the output type, then this specifies an expression that
will be used as a return value.  This expression can use any of the
previous labels, including a label given for the output which can be
used to access the actual foreign return value.</p><p>In rare cases where complete control over the input arguments is needed, the
wrapper&rsquo;s argument list can be specified as <span class="RktSym">args</span>, in any form (including
a &ldquo;rest&rdquo; argument).  Identifiers in this place are related to type labels, so
if an argument is there is no need to use an expression.</p><p>For example,</p><p><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">s</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">::</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">s</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="String_Types.html#(def._((lib._ffi/unsafe..rkt).__string))" class="RktValLink" pltdoc="x">_string</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">n</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__int))" class="RktValLink" pltdoc="x">_int</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/Function_Contracts.html#(form._((lib._racket/contract..rkt)._-~3e))" class="RktStxLink" pltdoc="x">-&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__int))" class="RktValLink" pltdoc="x">_int</a></span><span class="RktPn">)</span></p><p>specifies a function that receives an integer and a string, but the
foreign function receives the string first.</p><p><div class="SIntrapara"><table cellspacing="0" class="boxed"><tr><td><span class="RktPn">(</span><a name="(dep._((lib._ffi/unsafe..rkt)._function-ptr))"></a><a name="(def._((lib._ffi/unsafe..rkt)._function-ptr))"></a><span title="Provided from: ffi/unsafe"><span class="RktSym"><a href="#(def._((lib._ffi/unsafe..rkt)._function-ptr))" class="RktValLink" pltdoc="x">function-ptr</a></span></span><span class="hspace">&nbsp;</span><span class="RktVar">ptr-or-proc</span><span class="hspace">&nbsp;</span><span class="RktVar">fun-type</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span>&rarr;<span class="hspace">&nbsp;</span><span class="RktSym"><a href="foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._cpointer~3f))" class="RktValLink" pltdoc="x">cpointer?</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">ptr-or-proc</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._or))" class="RktStxLink" pltdoc="x">or</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="foreign_pointer-funcs.html#(def._((quote._~23~25foreign)._cpointer~3f))" class="RktValLink" pltdoc="x">cpointer?</a></span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="../reference/procedures.html#(def._((quote._~23~25kernel)._procedure~3f))" class="RktValLink" pltdoc="x">procedure?</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">fun-type</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="ctype.html#(def._((quote._~23~25foreign)._ctype~3f))" class="RktValLink" pltdoc="x">ctype?</a></span></td></tr></table></div><div class="SIntrapara">Casts <span class="RktVar">ptr-or-proc</span> to a function pointer of type <span class="RktVar">fun-type</span>.</div></p><h5>3.6.1<tt>&nbsp;</tt><a name="(part._foreign~3acustom-types)"></a>Custom Function Types</h5><p>The behavior of the <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span> type can be customized via
<a name="(tech._custom._function._type)"></a><span style="font-style: italic">custom function types</span>, which are pieces of syntax that can
behave as C types and C type constructors, but they can interact with
function calls in several ways that are not possible otherwise.  When
the <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span> form is expanded, it tries to expand each of the
given type expressions, and ones that expand to certain keyword-value
lists interact with the generation of the foreign function wrapper.
This expansion makes it possible to construct a single wrapper
function, avoiding the costs involved in compositions of higher-order
functions.</p><p>Custom function types are macros that expand to a sequence
<span class="RktPn">(</span><span class="RktVar">key:</span><span class="stt"> </span><span class="RktVar">val</span><span class="stt"> </span><span class="RktSym"><a href="../reference/stx-patterns.html#(form._((lib._racket/private/stxcase-scheme..rkt)._......))" class="RktStxLink" pltdoc="x">...</a></span><span class="RktPn">)</span>, where each <span class="RktVar">key:</span> is from a short list
of known keys.  Each key interacts with generated wrapper functions in
a different way, which affects how its corresponding argument is
treated:</p><ul><li><p><span class="RktSym">type:</span> specifies the foreign type that should be used, if it is
<span class="RktVal">#f</span> then this argument does not participate in the foreign call.</p></li><li><p><span class="RktSym">expr:</span> specifies an expression to be used for arguments of this
type, removing it from wrapper arguments.</p></li><li><p><span class="RktSym">bind:</span> specifies a name that is bound to the original
argument if it is required later (e.g., <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__box))" class="RktStxLink" pltdoc="x">_box</a></span> converts its
associated value to a C pointer, and later needs to refer back to
the original box).</p></li><li><p><span class="RktSym">1st-arg:</span> specifies a name that can be used to refer to
the first argument of the foreign call (good for common cases where
the first argument has a special meaning, e.g., for method calls).</p></li><li><p><span class="RktSym">prev-arg:</span> similar to <span class="RktSym">1st-arg:</span>, but refers to the
previous argument.</p></li><li><p><span class="RktSym">pre:</span> a pre-foreign code chunk that is used to change the
argument&rsquo;s value.</p></li><li><p><span class="RktSym">post:</span> a similar post-foreign code chunk.</p></li><li><p><span class="RktSym">keywords:</span> specifies keyword/value expressions that will
be used with the surrounding <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span> form.  (Note: the
keyword/value sequence follows <span class="RktSym">keywords:</span>, not parenthesized.)</p></li></ul><p>The <span class="RktSym">pre:</span> and <span class="RktSym">post:</span> bindings can be of the form
<span class="RktPn">(</span><span class="RktVar">id</span><span class="stt"> </span><span class="RktSym"><a href="../reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._~3d~3e))" class="RktStxLink" pltdoc="x">=&gt;</a></span><span class="stt"> </span><span class="RktVar">expr</span><span class="RktPn">)</span> to use the existing value.  Note that if the
<span class="RktSym">pre:</span> expression is not <span class="RktPn">(</span><span class="RktVar">id</span><span class="stt"> </span><span class="RktSym"><a href="../reference/if.html#(form._((lib._racket/private/letstx-scheme..rkt)._~3d~3e))" class="RktStxLink" pltdoc="x">=&gt;</a></span><span class="stt"> </span><span class="RktVar">expr</span><span class="RktPn">)</span>, then it means
that there is no input for this argument to the
<span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span>-generated procedure.  Also note that if a custom type is
used as an output type of a function, then only the <span class="RktSym">post:</span>
code is used.</p><p>Most custom types are meaningful only in a <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span> context, and
will raise a syntax error if used elsewhere.  A few such types can be
used in non-<span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span> contexts: types which use only
<span class="RktSym">type:</span>, <span class="RktSym">pre:</span>, <span class="RktSym">post:</span>, and no others.  Such
custom types can be used outside a <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span> by expanding them
into a usage of <span class="RktSym"><a href="ctype.html#(def._((quote._~23~25foreign)._make-ctype))" class="RktValLink" pltdoc="x">make-ctype</a></span>, using other keywords makes this
impossible, because it means that the type has specific interaction
with a function call.</p><p><div class="SIntrapara"><table cellspacing="0" class="boxed"><tr><td><span class="RktPn">(</span><a name="(dep._((lib._ffi/unsafe..rkt)._define-fun-syntax))"></a><a name="(form._((lib._ffi/unsafe..rkt)._define-fun-syntax))"></a><span title="Provided from: ffi/unsafe"><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt)._define-fun-syntax))" class="RktStxLink" pltdoc="x">define-fun-syntax</a></span></span><span class="hspace">&nbsp;</span><span class="RktVar">id</span><span class="hspace">&nbsp;</span><span class="RktVar">transformer-expr</span><span class="RktPn">)</span></td></tr></table></div><div class="SIntrapara">Binds <span class="RktVar">id</span> as a <a href="#(tech._custom._function._type)" class="techoutside" pltdoc="x"><span class="techinside">custom function type</span></a>. The type is
expanded by applying the procedure produced by
<span class="RktVar">transformer-expr</span> to a use of the <a href="#(tech._custom._function._type)" class="techoutside" pltdoc="x"><span class="techinside">custom function
type</span></a>.</div></p><p><div class="SIntrapara"><table cellspacing="0" class="boxed"><tr><td><a name="(dep._((lib._ffi/unsafe..rkt).__~3f))"></a><a name="(form._((lib._ffi/unsafe..rkt).__~3f))"></a><span title="Provided from: ffi/unsafe"><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__~3f))" class="RktStxLink" pltdoc="x">_?</a></span></span></td></tr></table></div><div class="SIntrapara">A <a href="#(tech._custom._function._type)" class="techoutside" pltdoc="x"><span class="techinside">custom function type</span></a> that is a marker for expressions that
should not be sent to the foreign function.  Use this to bind local
values in a computation that is part of an ffi wrapper interface, or
to specify wrapper arguments that are not sent to the foreign function
(e.g., an argument that is used for processing the foreign output).</div></p><p><div class="SIntrapara"><table cellspacing="0" class="boxed"><tr><td><span class="RktPn">(</span><a name="(dep._((lib._ffi/unsafe..rkt).__ptr))"></a><a name="(form._((lib._ffi/unsafe..rkt).__ptr))"></a><span title="Provided from: ffi/unsafe"><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__ptr))" class="RktStxLink" pltdoc="x">_ptr</a></span></span><span class="hspace">&nbsp;</span><span class="RktVar">mode</span><span class="hspace">&nbsp;</span><span class="RktVar">type-expr</span><span class="RktPn">)</span></td></tr><tr><td><span class="stt">&nbsp;</span></td></tr><tr><td><table cellspacing="0" class="specgrammar"><tr><td align="right" valign="baseline"><span class="RktVar">mode</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">=</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktSym">i</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktSym">o</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktSym">io</span></td></tr></table></td></tr></table></div><div class="SIntrapara">Creates a C pointer type, where <span class="RktVar">mode</span> indicates input or
output pointers (or both).  The <span class="RktVar">mode</span> can be one of the
following:</div></p><ul><li><p><span class="RktSym">i</span>  &ndash;  indicates an <span style="font-style: italic">input</span> pointer argument:
the wrapper arranges for the function call to receive a value that
can be used with the <span class="RktSym">type</span> and to send a pointer to this
value to the foreign function.  After the call, the value is
discarded.</p></li><li><p><span class="RktSym">o</span>  &ndash;  indicates an <span style="font-style: italic">output</span> pointer argument:
the foreign function expects a pointer to a place where it will save
some value, and this value is accessible after the call, to be used
by an extra return expression.  If <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__ptr))" class="RktStxLink" pltdoc="x">_ptr</a></span> is used in this
mode, then the generated wrapper does not expect an argument since
one will be freshly allocated before the call.</p></li><li><p><span class="RktSym">io</span>  &ndash;  combines the above into an
<span style="font-style: italic">input/output</span> pointer argument: the wrapper gets the Racket
value, allocates and set a pointer using this value, and then
references the value after the call.  The &ldquo;<span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__ptr))" class="RktStxLink" pltdoc="x">_ptr</a></span>&rdquo; name can
be confusing here: it means that the foreign function expects a
pointer, but the generated wrapper uses an actual value.  (Note that
if this is used with structs, a struct is created when calling the
function, and a copy of the return value is made too &ndash; which is
inefficient, but ensures that structs are not modified by C code.)</p></li></ul><p>For example, the <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__ptr))" class="RktStxLink" pltdoc="x">_ptr</a></span> type can be used in output mode to create a
foreign function wrapper that returns more than a single argument.  The
following type:</p><p><table cellspacing="0" class="RktBlk"><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__fun))" class="RktStxLink" pltdoc="x">_fun</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">i</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__ptr))" class="RktStxLink" pltdoc="x">_ptr</a></span><span class="hspace">&nbsp;</span><span class="RktSym">o</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#(def._((lib._ffi/unsafe..rkt).__int))" class="RktValLink" pltdoc="x">_int</a></span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPlain"><span class="hspace">&nbsp;&nbsp;</span></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/Function_Contracts.html#(form._((lib._racket/contract..rkt)._-~3e))" class="RktStxLink" pltdoc="x">-&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">d</span><span class="hspace">&nbsp;</span><span class="RktSym">:</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="Numeric_Types.html#(def._((quote._~23~25foreign).__double))" class="RktValLink" pltdoc="x">_double</a></span><span class="RktPn">)</span></td></tr><tr><td><span class="RktPlain"><span class="hspace">&nbsp;&nbsp;</span></span><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym"><a href="../reference/Function_Contracts.html#(form._((lib._racket/contract..rkt)._-~3e))" class="RktStxLink" pltdoc="x">-&gt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="../reference/values.html#(def._((quote._~23~25kernel)._values))" class="RktValLink" pltdoc="x">values</a></span><span class="hspace">&nbsp;</span><span class="RktSym">d</span><span class="hspace">&nbsp;</span><span class="RktSym">i</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></p><p>creates a function that calls the foreign function with a fresh
integer pointer, and use the value that is placed there as a second
return value.</p><p><div class="SIntrapara"><table cellspacing="0" class="boxed"><tr><td><a name="(dep._((lib._ffi/unsafe..rkt).__box))"></a><a name="(form._((lib._ffi/unsafe..rkt).__box))"></a><span title="Provided from: ffi/unsafe"><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__box))" class="RktStxLink" pltdoc="x">_box</a></span></span></td></tr></table></div><div class="SIntrapara">A <a href="#(tech._custom._function._type)" class="techoutside" pltdoc="x"><span class="techinside">custom function type</span></a> similar to a <span class="RktPn">(</span><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__ptr))" class="RktStxLink" pltdoc="x">_ptr</a></span><span class="stt"> </span><span class="RktSym">io</span><span class="stt"> </span><span class="RktVar">type</span><span class="RktPn">)</span>
argument, where the input is expected to be a box holding an
appropriate value, which is unboxed on entry and modified accordingly
on exit.</div></p><p><div class="SIntrapara"><table cellspacing="0" class="boxed"><tr><td><span class="RktPn">(</span><a name="(dep._((lib._ffi/unsafe..rkt).__list))"></a><a name="(form._((lib._ffi/unsafe..rkt).__list))"></a><span title="Provided from: ffi/unsafe"><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__list))" class="RktStxLink" pltdoc="x">_list</a></span></span><span class="hspace">&nbsp;</span><span class="RktVar">mode</span><span class="hspace">&nbsp;</span><span class="RktVar">type</span><span class="hspace">&nbsp;</span><span class="RktVar">maybe-len</span><span class="RktPn">)</span></td></tr><tr><td><span class="stt">&nbsp;</span></td></tr><tr><td><table cellspacing="0" class="specgrammar"><tr><td align="right" valign="baseline"><span class="RktVar">mode</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">=</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktVar">i</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktVar">o</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktVar">io</span></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td></tr><tr><td align="right" valign="baseline"><span class="RktVar">maybe-len</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">=</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><table cellspacing="0" class="RktBlk"><tr><td></td></tr></table></td></tr><tr><td align="right" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="center" valign="baseline">|</td><td align="left" valign="baseline"><span class="stt">&nbsp;</span></td><td align="left" valign="baseline"><span class="RktVar">len-expr</span></td></tr></table></td></tr></table></div><div class="SIntrapara">A <a href="#(tech._custom._function._type)" class="techoutside" pltdoc="x"><span class="techinside">custom function type</span></a> that is similar to <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__ptr))" class="RktStxLink" pltdoc="x">_ptr</a></span>, except
that it is used for converting lists to/from C vectors.  The optional
<span class="RktVar">maybe-len</span> argument is needed for output values where it is used in
the post code, and in the pre code of an output mode to allocate the
block.  In either case, it can refer to a previous binding for the
length of the list which the C function will most likely require.</div></p><p><div class="SIntrapara"><table cellspacing="0" class="boxed"><tr><td><span class="RktPn">(</span><a name="(dep._((lib._ffi/unsafe..rkt).__vector))"></a><a name="(form._((lib._ffi/unsafe..rkt).__vector))"></a><span title="Provided from: ffi/unsafe"><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__vector))" class="RktStxLink" pltdoc="x">_vector</a></span></span><span class="hspace">&nbsp;</span><span class="RktVar">mode</span><span class="hspace">&nbsp;</span><span class="RktVar">type</span><span class="hspace">&nbsp;</span><span class="RktVar">maybe-len</span><span class="RktPn">)</span></td></tr></table></div><div class="SIntrapara">A <a href="#(tech._custom._function._type)" class="techoutside" pltdoc="x"><span class="techinside">custom function type</span></a> like <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__list))" class="RktStxLink" pltdoc="x">_list</a></span>, except that it uses
Racket vectors instead of lists.</div></p><p><div class="SIntrapara"><table cellspacing="0" class="boxed"><tr><td><span class="RktPn">(</span><a name="(dep._((lib._ffi/unsafe..rkt).__bytes))"></a><a name="(form._((lib._ffi/unsafe..rkt).__bytes))"></a><span title="Provided from: ffi/unsafe"><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__bytes))" class="RktStxLink" pltdoc="x">_bytes</a></span></span><span class="hspace">&nbsp;</span><span class="RktSym">o</span><span class="hspace">&nbsp;</span><span class="RktVar">len-expr</span><span class="RktPn">)</span></td></tr><tr><td><span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__bytes))" class="RktStxLink" pltdoc="x">_bytes</a></span></td></tr></table></div><div class="SIntrapara">A <a href="#(tech._custom._function._type)" class="techoutside" pltdoc="x"><span class="techinside">custom function type</span></a> that can be used by itself as a simple
type for a byte string as a C pointer.  Alternatively, the second form
is for a pointer return value, where the size should be explicitly
specified.</div></p><p>There is no need for other modes: input or input/output would be just
like <span class="RktSym"><a href="#(form._((lib._ffi/unsafe..rkt).__bytes))" class="RktStxLink" pltdoc="x">_bytes</a></span>, since the string carries its size information
(there is no real need for the <span class="RktSym">o</span> part of the syntax, but it
is present for consistency with the above macros).</p><div class="navsetbottom"><span class="navleft"><form class="searchform"><input class="searchbox" style="color: #888;" type="text" value="...search manuals..." title="Enter a search string to search the manuals" onkeypress="return DoSearchKey(event, this, &quot;5.0.2&quot;, &quot;../&quot;);" onfocus="this.style.color=&quot;black&quot;; this.style.textAlign=&quot;left&quot;; if (this.value == &quot;...search manuals...&quot;) this.value=&quot;&quot;;" onblur="if (this.value.match(/^ *$/)) { this.style.color=&quot;#888&quot;; this.style.textAlign=&quot;center&quot;; this.value=&quot;...search manuals...&quot;; }" /></form>&nbsp;&nbsp;<a href="../index.html" title="up to the documentation top" pltdoc="x" onclick="return GotoPLTRoot(&quot;5.0.2&quot;);">top</a></span><span class="navright"><a href="Pointer_Types.html" title="backward to &quot;3.5 Pointer Types&quot;" pltdoc="x">&larr; prev</a>&nbsp;&nbsp;<a href="types.html" title="up to &quot;3 C Types&quot;" pltdoc="x">up</a>&nbsp;&nbsp;<a href="C_Struct_Types.html" title="forward to &quot;3.7 C Struct Types&quot;" pltdoc="x">next &rarr;</a></span>&nbsp;</div></div></div><div id="contextindicator">&nbsp;</div></body></html>